// Script Supabase corretto per moduli ES
console.log("Inizio script");
const supabaseUrl = 'https://wenndkgeebooikzikhew.supabase.co';
const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlbm5ka2dlZWJvb2lremlraGV3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDIwMjk0NjUsImV4cCI6MjA1NzYwNTQ2NX0.4_Pnkffn1mPUkHyYfk6bDmdWk2L14LTV5hEEvDaWu8c';

// Usa la versione 2 di Supabase con supporto corretto
document.addEventListener('DOMContentLoaded', function() {
    // Accedi correttamente all'oggetto Supabase
    const client = supabase.createClient(supabaseUrl, supabaseAnonKey);
    console.log("Client Supabase inizializzato", client);
    
    document.getElementById("beta-form").addEventListener("submit", async function(event) {
        console.log("Evento submit intercettato");
        event.preventDefault();
        const email = document.getElementById("email").value;
        console.log("Email:", email);
        const message = document.getElementById("message");
        
        try {
            // Registra l'utente su Supabase Auth con options correttamente strutturate
            const { data, error } = await client.auth.signUp({
                email: email,
                password: 'temporary-password',
                options: {
                    emailRedirectTo: 'https://apigoal.com/survey.html'
                }
            });
            
            if (error) {
                console.log("Errore Supabase:", error);
                message.innerText = `❌ Something went wrong: ${error.message}`;
                message.classList.add("text-red-600");
            } else {
                console.log("Registrazione completata:", data);

                // Inserisci l'utente nella tabella 'users' del database
                const { error: insertError } = await client
                    .from('beta_testers') // Cambia con il nome della tua tabella in Supabase
                    .insert([
                        { 
                            email: email,
                            user_id: data.user.id,  // Usa l'ID dell'utente autenticato
                            created_at: new Date().toISOString()
                        }
                    ]);

                if (insertError) {
                    console.log("Errore inserimento in database:", insertError);
                    message.innerText = `⚠️ Signed up, but database entry failed: ${insertError.message}`;
                    message.classList.add("text-yellow-600");
                } else {
                    message.innerText = "✅ Thank you! Check your email for verification.";
                    message.classList.add("text-green-600");
                }
            }
        } catch (error) {
            console.log("Errore catch:", error);
            message.innerText = "❌ Network error. Try again later.";
            message.classList.add("text-red-600");
        }
    });
});

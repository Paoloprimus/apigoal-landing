<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Welcome to APIGOAL!</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body class="bg-gradient-to-b from-gray-100 to-gray-300 text-gray-900 flex items-center justify-center min-h-screen">

    <div class="bg-white shadow-xl rounded-lg p-8 max-w-md w-full text-center">
        <h1 class="text-2xl font-bold mb-2">🎯 WELCOME TO APIGOAL!</h1>
        
		<!-- Larger green intro box with icon -->
        <div class="bg-green-50 p-4 rounded-lg mb-6 border border-green-200">
            <p class="text-base text-green-700 flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
                Please complete this survey to join us. All beta program details in the dashboard after submission. Thank you!
            </p>
            <p class="text-sm text-green-600 mt-2">

            </p>
        </div>

        <form id="survey-form" class="mt-4 text-left">
            <!-- First question - Ranking system with radio buttons -->
            <label class="block text-lg font-semibold mb-2">
                Qualify the importance of the following features (1=high priority, 4=low priority):
            </label>
            
            <!-- Auto Switch -->
            <div class="mb-4 p-2 bg-gray-50 rounded">
                <p class="mb-1 font-medium">Automatic switching to the most cost-effective AI APIs</p>
                <div class="flex flex-wrap gap-4 sm:gap-6">
                    <label class="flex items-center">
                        <input type="radio" name="rank_auto_switch" value="1" class="mr-1">
                        <span>1</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="rank_auto_switch" value="2" class="mr-1">
                        <span>2</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="rank_auto_switch" value="3" class="mr-1">
                        <span>3</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="rank_auto_switch" value="4" class="mr-1">
                        <span>4</span>
                    </label>
                </div>
            </div>
            
            <!-- Cost Comparison -->
            <div class="mb-4 p-2 bg-gray-50 rounded">
                <p class="mb-1 font-medium">Real-time cost comparison with equivalent alternative AI APIs</p>
                <div class="flex flex-wrap gap-4 sm:gap-6">
                    <label class="flex items-center">
                        <input type="radio" name="rank_cost_comparison" value="1" class="mr-1">
                        <span>1</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="rank_cost_comparison" value="2" class="mr-1">
                        <span>2</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="rank_cost_comparison" value="3" class="mr-1">
                        <span>3</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="rank_cost_comparison" value="4" class="mr-1">
                        <span>4</span>
                    </label>
                </div>
            </div>
            
            <!-- Cost Monitoring -->
            <div class="mb-4 p-2 bg-gray-50 rounded">
                <p class="mb-1 font-medium">Real-time monitoring of overall and analytical AI API costs</p>
                <div class="flex flex-wrap gap-4 sm:gap-6">
                    <label class="flex items-center">
                        <input type="radio" name="rank_cost_monitoring" value="1" class="mr-1">
                        <span>1</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="rank_cost_monitoring" value="2" class="mr-1">
                        <span>2</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="rank_cost_monitoring" value="3" class="mr-1">
                        <span>3</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="rank_cost_monitoring" value="4" class="mr-1">
                        <span>4</span>
                    </label>
                </div>
            </div>
            
            <!-- Efficiency/Security Monitoring -->
            <div class="mb-4 p-2 bg-gray-50 rounded">
                <p class="mb-1 font-medium">Real-time monitoring of AI API efficiency and security</p>
                <div class="flex flex-wrap gap-4 sm:gap-6">
                    <label class="flex items-center">
                        <input type="radio" name="rank_efficiency_security" value="1" class="mr-1">
                        <span>1</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="rank_efficiency_security" value="2" class="mr-1">
                        <span>2</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="rank_efficiency_security" value="3" class="mr-1">
                        <span>3</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="rank_efficiency_security" value="4" class="mr-1">
                        <span>4</span>
                    </label>
                </div>
            </div>

            <!-- New question about AI API providers -->
            <label class="block text-lg font-semibold mb-2">
                Which AI API providers are you currently using? (Select all that apply)
            </label>
            <div class="mb-4 space-y-2">
                <label class="flex items-center">
                    <input type="checkbox" name="providers" value="openai" class="mr-2">
                    OpenAI (GPT models)
                </label>
                <label class="flex items-center">
                    <input type="checkbox" name="providers" value="anthropic" class="mr-2">
                    Anthropic (Claude models)
                </label>
                <label class="flex items-center">
                    <input type="checkbox" name="providers" value="google" class="mr-2">
                    Google (Gemini models)
                </label>
                <label class="flex items-center">
                    <input type="checkbox" name="providers" value="deepseek" class="mr-2">
                    DeepSeek
                </label>
                <label class="flex items-center">
                    <input type="checkbox" name="providers" value="ngrok" class="mr-2">
                    Ngrok
                </label>

<label class="flex items-center">
                    <input type="checkbox" name="providers" value="mistral" class="mr-2">
                    Mistral AI
                </label>

                <label class="flex items-center">
                    <input type="checkbox" name="providers" value="other" class="mr-2">
                    Other (please specify in the comments)
                </label>
            </div>

            <!-- Simplified monthly budget question -->
            <label class="block text-lg font-semibold mb-2">
                What is your current monthly budget for AI APIs?
            </label>
            <div class="mb-4">
                <label class="flex items-center">
                    <input type="radio" name="budget" value="under_100" class="mr-2">
                    Under $100
                </label>
                <label class="flex items-center">
                    <input type="radio" name="budget" value="100_1000" class="mr-2">
                    $100 - $1,000
                </label>
                <label class="flex items-center">
                    <input type="radio" name="budget" value="1000_plus" class="mr-2">
                    Over $1,000
                </label>
            </div>

            <!-- New question about usage type -->
            <label class="block text-lg font-semibold mb-2">
                What are your primary AI API use cases? (Select all that apply)
            </label>
            <div class="mb-4 space-y-2">
                <label class="flex items-center">
                    <input type="checkbox" name="use_cases" value="text_generation" class="mr-2">
                    Text generation/completion
                </label>
                <label class="flex items-center">
                    <input type="checkbox" name="use_cases" value="embeddings" class="mr-2">
                    Embeddings/Vector operations
                </label>
                <label class="flex items-center">
                    <input type="checkbox" name="use_cases" value="image_generation" class="mr-2">
                    Image generation
                </label>
                <label class="flex items-center">
                    <input type="checkbox" name="use_cases" value="analysis" class="mr-2">
                    Content analysis/moderation
                </label>
                <label class="flex items-center">
                    <input type="checkbox" name="use_cases" value="other" class="mr-2">
                    Other (please specify in comments)
                </label>
            </div>

            <!-- Second original question -->
            <label class="block text-lg font-semibold mb-2">
                Select your preferences:
            </label>
            <div class="mb-4">
                <label class="block text-md font-medium mb-1">Dashboard presentation:</label>
                <label class="flex items-center">
                    <input type="radio" name="dashboard_option" value="dashboard_only" class="mr-2">
                    Dashboard only
                </label>
                <label class="flex items-center">
                    <input type="radio" name="dashboard_option" value="dashboard_widgets" class="mr-2">
                    Dashboard + widgets
                </label>
            </div>
            <div class="mb-4">
                <label class="block text-md font-medium mb-1">Usage type:</label>
                <label class="flex items-center">
                    <input type="radio" name="usage_option" value="individuals" class="mr-2">
                    For individual professionals
                </label>
                <label class="flex items-center">
                    <input type="radio" name="usage_option" value="teams" class="mr-2">
                    For teams
                </label>
            </div>

            <!-- Third item - optional comments -->
            <label class="block text-lg font-semibold mb-2">
                Let us know what interests you most about the service (specific cost optimization needs, security requirements, switching concerns, etc.):
            </label>
		<textarea id="custom_request" name="custom_request" class="w-full p-2 border 			rounded-lg mt-1 mb-4" 
          	placeholder="Write here (optional)..."></textarea>

            <!-- Messaggio di contatto -->
            <p class="text-sm text-gray-600 mb-4">
                Feel free to contact us at <a href="mailto:info@apigoal.com" class="text-blue-600 underline">info@apigoal.com</a> for any requests.  
                Thank you for your availability!
            </p>

            <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">
                Join Beta-APIGOAL Dashboard
            </button>
        </form>
    </div>

<script>
document.addEventListener("DOMContentLoaded", async function() {
    console.log("📌 Document loaded. Initializing Supabase...");

    if (typeof supabase === 'undefined') {
        console.error("❌ Supabase library not loaded.");
        return;
    }

    const supabaseUrl = 'https://wenndkgeebooikzikhew.supabase.co';
    const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlbm5ka2dlZWJvb2lremlraGV3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDIwMjk0NjUsImV4cCI6MjA1NzYwNTQ2NX0.4_Pnkffn1mPUkHyYfk6bDmdWk2L14LTV5hEEvDaWu8c';

    const supabaseClient = supabase.createClient(supabaseUrl, supabaseAnonKey);
    console.log("✅ Supabase client initialized:", supabaseClient);

    async function checkSurveyStatus() {
        try {
            console.log("🔍 Checking user authentication...");
            const { data: { user }, error } = await supabaseClient.auth.getUser();

            if (error) {
                console.error("⚠️ Error retrieving user:", error);
                return;
            }

            if (!user) {
                console.warn("🚫 No user logged in, staying on survey page.");
                return;  // NON REDIRECTARE, così vediamo se il problema è qui
            }

            console.log("✅ User found:", user);

            const { data, error: surveyError } = await supabaseClient
                .from('beta_survey')
                .select('*')
                .eq('user_id', user.id);

            if (surveyError) {
                console.error("⚠️ Failed to fetch survey data:", surveyError);
                return;
            }

            console.log("📊 Survey data:", data);

            if (data.length > 0) {
                console.log("🔄 User already completed survey, redirecting...");
                window.location.href = "https://apigoal.com/beta_dashboard";
            }
        } catch (error) {
            console.error("❌ Survey Check Error:", error);
        }
    }

    await checkSurveyStatus();

    document.getElementById("survey-form").addEventListener("submit", async function(event) {
        event.preventDefault();

        console.log("📝 Submitting survey...");

        const { data: { user }, error } = await supabaseClient.auth.getUser();
        if (!user) {
            alert("Error: User not logged in. Please refresh the page.");
            return;
        }

        console.log("✅ User found for survey submission:", user);

        // Legge i dati dai radio button
        const rankAutoSwitch = document.querySelector('input[name="rank_auto_switch"]:checked')?.value || null;
        const rankCostComparison = document.querySelector('input[name="rank_cost_comparison"]:checked')?.value || null;
        const rankCostMonitoring = document.querySelector('input[name="rank_cost_monitoring"]:checked')?.value || null;
        const rankEfficiencySecurity = document.querySelector('input[name="rank_efficiency_security"]:checked')?.value || null;

	// Recupero il valore del budget
	const budget = document.querySelector('input[name="budget"]:checked')?.value || null;
	console.log("🔍 Budget Type:", typeof budget, "Value:", budget);

        // Opzioni aggiuntive
        const dashboardOption = document.querySelector('input[name="dashboard_option"]:checked')?.value || null;
        const usageOption = document.querySelector('input[name="usage_option"]:checked')?.value || null;
        const customRequest = document.getElementById("custom_request").value.trim();
	// Controlla se almeno una checkbox dei use_cases è selezionata
	const selectedUseCases = Array.from(document.querySelectorAll('input[name="use_cases"]:checked'))
                              .map(input => input.value);
	console.log("🔍 Use Cases:", selectedUseCases);

        // Controlla se almeno una checkbox è selezionata
        const selectedProviders = Array.from(document.querySelectorAll('input[name="providers"]:checked'))
                                      .map(input => input.value);

        if (selectedProviders.length === 0) {
            alert("⚠️ Please select at least one AI API provider.");
            return;
        }

        // Verifica se i dati richiesti sono tutti presenti
        if (!rankAutoSwitch || !rankCostComparison || !rankCostMonitoring || !rankEfficiencySecurity) {
            alert("⚠️ Please rank all features before submitting.");
            return;
        }

	// Controlla se il budget è selezionato
	if (!budget) {
    	    alert("⚠️ Please select your monthly AI API budget.");
            return;
	}
	    
        try {
            const { error } = await supabaseClient
                .from('beta_survey')
                .insert([{
                    user_id: user.id,
                    rank_auto_switch: rankAutoSwitch,
                    rank_cost_comparison: rankCostComparison,
                    rank_cost_monitoring: rankCostMonitoring,
                    rank_efficiency_security: rankEfficiencySecurity,
                    dashboard_option: dashboardOption,
                    usage_option: usageOption,
                    custom_request: customRequest,
                    providers: selectedProviders,
		    budget: budget // <-- Assicuriamoci che venga inviato
		    use_cases: selectedUseCases // ✅ Aggiunto
                }]);

            if (error) {
                console.error("❌ Survey Error:", error);
                alert("Error submitting survey. Try again.");
            } else {
                console.log("🎉 Survey submitted successfully!");
                window.location.href = "https://apigoal.com/beta_dashboard";
            }
        } catch (error) {
            console.error("❌ Network Error:", error);
            alert("Network error. Try again later.");
        }
    });
});
</script>


</body>
</html>
